{% set indent_increment = 4 %}

{%- macro nginx_block(value, key=None, operator=' ', delim=';', ind=0) -%}
{%-   if value != None and key != 'load_module' -%}
{%-     if value is number or value is string -%}
        {{ key|indent(ind, True) }}{{ operator }}{{ value }}{{ delim }}
{%-     elif value is mapping -%}
        {{ key|indent(ind, True) }}{{ operator }}{{ '{' }}
{%-       if 'log_format' in value and value['log_format'] != [] -%}
{{ nginx_block(value['log_format'], 'log_format', operator, delim, (ind + indent_increment)) }}
{%-       endif -%}
{%-       for k, v in value.items() %}
{%-         if k != 'include' and k != 'log_format' %}
{{ nginx_block(v, k, operator, delim, (ind + indent_increment)) }}
{%-         endif %}
{%-       endfor %}
{%-       if 'include' in value.keys() %}
{{ nginx_block(value['include'], 'include', operator, delim, (ind + indent_increment)) }}
{%-       endif %}
{{ '}'|indent(ind, True) }}
{%-     elif value is iterable -%}
{%-       for v in value %}
{{ nginx_block(v, key, operator, delim, ind) }}
{%-       endfor -%}
{%-     else -%}
{{ key|indent(ind, True) }}{{ operator }}{{ value }}{{ delim }}
{%-     endif -%}
{%-   else -%}
{%-   endif -%}
{%- endmacro -%}

# Default nginx server configuration
#
# **** DO NOT EDIT THIS FILE ****
#
# This file is managed by Salt.

{%- if 'load_module' in config.keys() %}
{%-   for v in config.load_module %}
load_module {{ v }};
{%-   endfor -%}
{%- endif %}

{%- if 'include' in config.keys() %}
{%-   for v in config.include %}
include {{ v }};
{%-   endfor %}
{%- endif %}

{%- for key, value in config.items() %}
{%-   if key not in ['load_module', 'include'] %}
{{ nginx_block(value, key) }}
{%-   endif %}
{%- endfor -%}
